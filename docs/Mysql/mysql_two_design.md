# 数据库逻辑设计

一般设计数据库要经历这么几个步骤：<font color=#1E90FF>业务分析</font> -> <font color=#1E90FF>逻辑设计</font> -> <font color=#1E90FF>数据类型</font> -> <font color=#1E90FF>对象命名</font> -> <font color=#1E90FF>建立库表</font>

## 业务分析
+ <font color=#3eaf7c>课程的属性</font>：主标题，副标题，方向，分类，难度，最新，最热，时长，简介，人数，需知，收获，将实名，讲师职位，课程图片，综合评分，内容实用，简洁易懂，逻辑清晰
+ <font color=#3eaf7c>课程列表的属性</font>：章节，小节名，说明，小节时长，章节URL,视频格式
+ <font color=#3eaf7c>讲师的属性</font>：讲师昵称，说明，性别，省，市，职位，说明，经验，积分，关注人数，粉丝人数
+ <font color=#3eaf7c>用户属性</font>：用户昵称，密码，说明，性别，省，市，职位，说明，经验，积分，关注人数，粉丝人数
+ <font color=#3eaf7c>问答评论属性</font>：类型，标题，内容，关联章节，浏览量，发布事件，用户昵称
+ <font color=#3eaf7c>笔记属性</font>：用户昵称，关联章节，笔记标题，笔记内容，发布时间
+ <font color=#3eaf7c>评价的属性</font>：用户，课程主标题，内容，综合评分，内容实用，简洁易懂，逻辑清晰，发布时间

对于一个对象，我们最容易想到的存储方式是<font color=#DD1144>宽表模式</font>，即将对象所有属性存在一个表里，但是宽表模式也有很多问题：
+ <font color=#3eaf7c>数据冗余</font>：相同的数据在一个表中出现多次，占用对象的存储空间
+ <font color=#3eaf7c>数据更新异常</font>：修改一行中某列的值时，同时修改了多行数据
+ <font color=#3eaf7c>数据插入异常</font>：部分数据由于缺失主键信息而无法写入表中
+ <font color=#3eaf7c>数据删除异常</font>：删除某一数据时不得不删除另一数据

当然了，宽表也并非一无是处，<font color=#1E90FF>宽表比较适合于一些配合列存储的数据报表应用</font>

## 设计范式
<font color=#1E90FF>**① 第一范式：表中所有的字段都不可再分**</font>

也就是必须要保持一个正儿八经的二维表的样子，不能在某个列下面在分出三个子列，比如联系方式下面有手机，家庭电话，单位电话等，出现这样的情况，手机，家庭电话，单位电话全部都是单独的一列即可，<font color=#DD1144>违反第一范式的将子列划分为单列即可</font>

<font color=#1E90FF>**② 第二范式：表中必须存在业务主键，并且非主键依赖于全部业务主键**</font>

主键有<font color=#1E90FF>单列主键</font>和<font color=#1E90FF>复合主键</font>，单列主键天生是符合第二范式的，但是复合主键就不一定了，比如复合主键是（哟用户，章节，标题），那么内容和时间就是依赖于这个复合主键的，因为内容和时间和复合主键中的三列都有关系，但是用户积分就不算，因为它只和用户有关系，和复合主键中的章节标题都没有关系，所以必须将其单独踢出去，单独建立一个用户表，将用户和用户积分放入，<font color=#DD1144>即违反第二范式的列，单独剔除，与相关的主键单独形成新表</font>

<font color=#1E90FF>**③ 第三范式：表中的非主键列之间不能相互依赖**</font>

比如在课程表中，有讲师名和讲师职位的信息，但是不能将两者都放在课程表中的单独两列，因为两者存在依赖关系，讲师职位是依赖讲师名的，但不依赖主标题这个主键，所以我们要将讲师职位单独剔除去和讲师名形成一个单独的新表讲师信息表。<font color=#DD1144>即违反第三范式的列只需要将其剔除，和依赖的主键放在单独的新表当中</font>

## 逻辑建模
在我们学习了设计范式后，我们就能根据设计范式对项目进行逻辑建模，但是实际上设计范式还有很多，只不过当前我们只学习了三个，根据项目的不同选择不同设计范式即可

### 1. 课程的属性分表

<img :src="$withBase('/mysql_two_class_field.png')" alt="课程的属性分表">

+ <font color=#1E90FF>最新</font>这个属性可以通过上线时间计算获取
+ <font color=#1E90FF>最热</font>这个属性可以通过学习人数来计算获得
+ 关于<font color=#DD1144>方向</font>、<font color=#DD1144>分类</font>、<font color=#DD1144>难度</font>这几个属性虽然和课程的主标题有关，但是如果直接放在课程表当中还是会出现之前我们提到的这些插入，更新，删除的异常，所以我们需要将他们放在其他单独的表中

### 2. 课程列表的属性分表

<img :src="$withBase('/mysql_two_classlist_field.png')" alt="课程列表的属性分表">

+ 首先对于课程列表的属性，章节名和小节名应该是作为一个复合主键，但是<font color=#1E90FF>说明</font>这个属性只和章节名有关系，后面几个属性只和小节名有关系，<font color=#1E90FF>所以如果全放在一个表当中是违反第二范式的设计规范</font>
+ 我们将和<font color=#1E90FF>课程章节名</font>有关的<font color=#1E90FF>说明</font>、<font color=#1E90FF>章节编号</font>全部放在课程章节表中，然后创建一个<font color=#DD1144>课程和章节的联系表</font>
+ 我们将和<font color=#1E90FF>小节名称</font>有关的<font color=#1E90FF>小节视频url</font>、<font color=#1E90FF>视频格式</font>等属性全部放在课程小节表中，然后创建一个<font color=#DD1144>章和小节的联系表</font>

### 3. 用户的属性分表

<img :src="$withBase('/mysql_two_user_field.png')" alt="用户的属性分表">

+ 对于用户分为<font color=#1E90FF>讲师</font>和<font color=#1E90FF>学生</font>、两者所有的属性都能靠各自的昵称来作为各自表中的主键使用，其他属性也都依赖于昵称这个属性，符合设计的三个范式
+ 另外实际上这个讲师表，在课程的属性分表中就有了，我们这里只不过是拓展了一下，但是你会发现如果将普通用户和讲师分别建表的话就会展示数据的冗余，所以我们只需要建立一张表，然后添加<font color=#1E90FF>讲师标识</font>来标注这个用户是否为讲师即可。

### 4. 问答评论对象的属性分表

<img :src="$withBase('/mysql_two_anwser_field.png')" alt="问答评论对象的属性分表">

+ 我们看到在问答评论中，其中只有将<font color=#1E90FF>标题</font>、<font color=#1E90FF>关联章节</font>、<font color=#1E90FF>用户昵称</font>三个放一起才能作为一条问答评论的唯一标识，但是其中，关联章节又必须依赖于在课程章和章节中的依赖主键。所以在问答评论表中我们应该将这三个属性全部放入
+ 另外每个问答评论都可以作为别人问答评论的回复，所以我们需要有一个特殊的<font color=#1E90FF>父评论标题</font>属性来记录这个问答评论是哪个标题的回复

### 5. 笔记对象的属性分表

<img :src="$withBase('/mysql_two_comment_field.png')" alt="笔记对象的属性分表">

+ 笔记对象的属性分表和问答评论分表十分类似，这里我们就不多说了。

### 6. 评价对象的属性分表

<img :src="$withBase('/mysql_two_access_field.png')" alt="评价的独享属性分表">

+ 对于评论表，我们将<font color=#1E90FF>用户昵称</font>和<font color=#1E90FF>课程主标题</font>作为联合主键，其他属性都依赖这两个属性。其中综合评分可以根据后面的内容实用等属性计算出来。
+ 还有个问题，用户必须选择了这门课才能进行评论，所以我们要创建一个<font color=#DD1144>用户选课表</font>，复合主键依旧是<font color=#1E90FF>用户昵称</font>和<font color=#1E90FF>课程主标题</font>

## 反范式化设计
通过上面的6个小的步骤我们就完成了数据库的表的范式化设计，但是这样做就真的完了，按照这样的范式化设计我们的查询到底方不方便，快不快？假如我们要查询一门课程的所有章和小节信息，我们就必须5个表联查，课程表，课程章节表，课程和章节的关系表，课程小节表，课程章和小节关系表，我们知道这样对于性能优化是不利的，<font color=#1E90FF>所以基于查询和性能上的考量，通常我们是要做一些违反范式化设计的操作来让查询和优化得以实现</font>

进行反范式化设计的时候，<font color=#DD1144>我们大多数都是用空间换时间的</font>，<font color=#1E90FF>换句话说就是为了提高查询速度适当增加数据的冗余</font>：

因为课程表和章节表是1对多的关系，按照我们之前设计的，查询一个课程的所有信息，要查课程表，根据课程名称查课程和章节的关系表，然后根据查出的章节来查询课程章节表，以此查出所有课程的章节信息，但是<font color=#DD1144>对于频繁查询的表我们为了提高性能可以进行合并</font>，我们将<font color=#1E90FF>课程章节表</font>和<font color=#1E90FF>课程同章节的联系表</font>进行合并，然后合成一个<font color=#DD1144>课程章节表</font>：
+ <font color=#3eaf7c>课程章节表</font>：<font color=#DD1144>课程主标题，课程章名</font>，章节说明，章节编号

虽然它是违反第二范式的，章节信息和课程主标题没有啥依赖，但是这样能减少一个表的查询，进而提高查询速度还是划算的，同理，课程小节表和课程章同小节关系表可以合并在一起：
+ <font color=#3eaf7c>课程小节表</font>：<font color=#DD1144>课程主题表，课程章名，小结名称</font>，小节视频url，视频格式，小节时长，小节编号

## 建表总结
到此为止，我们基本上对于表的大体设计已经完成，我们来看看表的具体信息：
+ <font color=#1E90FF>课程表</font>：<font color=#DD1144>主标题</font>，副标题，方向，分类，难度，上线时间，学习人数，时长，简介，需知，收获，讲师昵称，课程图片，综合评分，内容实用，简洁易懂，逻辑清晰
+ <font color=#1E90FF>课程章节表</font>：<font color=#DD1144>课程主标题</font>，<font color=#DD1144>章节名称</font>，章节说明，章节编号
+ <font color=#1E90FF>课程小节表</font>：<font color=#DD1144>课程主标题</font>，<font color=#DD1144>课程章名</font>，<font color=#DD1144>小节名称</font>，小节视频url，视频格式，小节时长，小节编号
+ <font color=#1E90FF>课程方向表</font>：<font color=#DD1144>课程方向名称</font>，添加时间
+ <font color=#1E90FF>课程分类表</font>：<font color=#DD1144>分类名称</font>，添加时间
+ <font color=#1E90FF>课程难度表</font>：<font color=#DD1144>课程难度</font>,添加时间
+ <font color=#1E90FF>用户表</font>：<font color=#DD1144>用户昵称</font>，密码，性别，省，市，职位，说明，经验，积分，关注人数，粉丝人数，讲师标识
+ <font color=#1E90FF>问答评论表</font>：<font color=#DD1144>标题</font>，<font color=#DD1144>课程主标题</font>，<font color=#DD1144>课程章名</font>，<font color=#DD1144>小节名称</font>，<font color=#DD1144>用户昵称</font>，父评论标题，内容，类型，浏览量，发布时间
+ <font color=#1E90FF>笔记表</font>：<font color=#DD1144>笔记标题</font>，<font color=#DD1144>课程主标题</font>，<font color=#DD1144>课程章名</font>，<font color=#DD1144>小节名称</font>，<font color=#DD1144>用户昵称</font>，笔记内容，发布时间
+ <font color=#1E90FF>评价表</font>：<font color=#DD1144>用户昵称</font>，<font color=#DD1144>课程主标题</font>，内容，综合评分，内容实用，简洁易懂，逻辑清晰，发布时间
+ <font color=#1E90FF>用户选课表</font>：<font color=#DD1144>用户昵称</font>，<font color=#DD1144>课程主标题</font>，选课时间，累积听课时长
