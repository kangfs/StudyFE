# 数据库物理设计

## Innodb
### 1. 存储引擎的选择
一般来说，表的物理设计包括表中每一列使用的数据类型，以及如何对表和库进行命名，<font color=#1E90FF>但是对于mysql来说呢，还要选择表所存储的存储引擎，mysql支持多种存储引擎，存储引擎又决定了表中实际数据存储的数据结构</font>。

为了能选择适合的存储引擎，我们首先要知道有哪些存储引擎可供我们选择：

<font color=#DD1144>**① MYISAM**</font>

事务为N，是`mysql`5.6之前的默认引擎，最常用的非事务性存储引擎，并不支持事务，同时在整个引擎中，<font color=#1E90FF>数据是以堆表的方式进行存储的</font>，并无特定的顺序。

<font color=#DD1144>**② CSV**</font>

事务为N，<font color=#1E90FF>使用csv文件格式来存储数据</font>，可以直接修改`CSV`文件的内容来修改表中的数据，和`MYISAM`一样，由于不支持事务，读写会枷锁，<font color=#1E90FF>所以我们通常使用csv来进行不同系统的数据交换</font>，但并不建议作为核心存储引擎来使用

<font color=#DD1144>**③ Archive**</font>

事务为N，适用场景极其特殊，<font color=#1E90FF>只允许查询和新增数据而不允许修改已有数据的非事务性存储引擎</font>，所以我们通常使用它来归档数据来记录日志的用途。

<font color=#DD1144>**④ Memory**</font>

事务为N，<font color=#1E90FF>是一种易失型非事务性存储引擎</font>，由于数据存储在内存当中，读写速度很快，适合I/O操作。但是一旦`mysql`实例重启，存储在`Memory`存储引擎中的数据就会消失，所以也不适合作为业务的核心存储引擎来使用。<font color=#1E90FF>这个存储引擎一般在mysql内部使用，执行比较长的sql会产生大量中间数据集，使用这种存储引擎来存储这种临时数据会提高sql语句的执行速度</font>

<font color=#DD1144>**⑤ INNODB**</font>

事务Y，<font color=#1E90FF>是mysql5.6之后默认的最常用的事务性存储引擎</font>

### 2. INNODB概述
`Innodb`的特点：
+ <font color=#3eaf7c>支持事务（ACID）</font>，其完全支持事务的原子性，一致性，隔离性和持久性，在需要事务支持的场景中，<font color=#1E90FF>一定不要混合使用事务性存储引擎和非事务存储引擎</font>
+ <font color=#3eaf7c>数据按主键聚集存储</font>：数据在逻辑上按照表中主键的顺序来存储的，一般建议有一个自增的id来作为主键使用的。<font color=#DD1144>按照之前的我们的业务设计，就需要给每个表添加一个自增id列来作为表的数据库主键，而之前的业务主键可以添加一个唯一索引，保证数据的唯一性</font>
+ <font color=#3eaf7c>支持行级锁及MVCC</font>:在读写的时候只会在读写的数据行上来枷锁，并不会想`MYISAM`在整个表上来枷锁。支持`mvcc`(多版本的并发控制)，可以进一步处理读写操作的互相阻塞，非常适合在这种读写混合的高并发场景中使用。
+ <font color=#3eaf7c>支持Btree和自适应Hash索引</font>
+ <font color=#3eaf7c>支持全文和空间索引</font>

### 3. 优化表结构
根据上述的`INNODB`的这些特点，我们给每个表添加一个自增id来作为数据库表的主键使用。通常这个数据库主键要比这个业务主键小很多，所以表和表之间的关联也可以依靠数据库主键来运行，这样比业务主键关联查询会更有效率。通过上述操作后我们再来看看表的结构的变化：
+ <font color=#3eaf7c>课程表</font>：<font color=#DD1144>课程ID</font>(<font color=#1E90FF>自增ID:1,2,3,4...</font>)，主标题，副标题，方向ID，分类ID，难度ID，上线时间，学习人数，时长，简介，需知，收获，讲师ID，课程图片，综合评分，内容实用，简洁易懂，逻辑清晰
+ <font color=#3eaf7c>课程章节表</font>：<font color=#DD1144>章节ID</font>,课程ID(<font color=#1E90FF>存储空间小，和课程表关联方便</font>)，章节名称，章节说明，章节编号
+ <font color=#3eaf7c>课程小节表</font>：<font color=#DD1144>小节ID</font>，课程ID，章节ID，小节名称，小节视频url，视频格式，小节时长，小节编号
+ <font color=#3eaf7c>课程方向表</font>：<font color=#DD1144>课程方向ID</font>，课程方向名称，添加时间
+ <font color=#3eaf7c>课程分类表</font>：<font color=#DD1144>课程分类ID</font>，分类名称，添加时间
+ <font color=#3eaf7c>课程难度表</font>：<font color=#DD1144>课程难度ID</font>，课程难度,添加时间
+ <font color=#3eaf7c>用户表</font>：<font color=#DD1144>用户ID</font>，用户昵称(<font color=#1E90FF>添加唯一索引</font>)，密码，性别，省，市，职位，说明，经验，积分，关注人数，粉丝人数，讲师标识
+ <font color=#3eaf7c>问答评论表</font>：<font color=#DD1144>评论ID</font>，父评论ID，课程ID，章节ID，小节ID，评论标题，用户ID，内容，类型，浏览量，发布时间
+ <font color=#3eaf7c>笔记表</font>：<font color=#DD1144>笔记ID</font>，课程ID，章节ID，小节ID，用户昵称，笔记内容，发布时间
+ <font color=#3eaf7c>评价表</font>：<font color=#DD1144>评价ID</font>，用户ID，课程ID，内容ID，综合评分，内容实用，简洁易懂，逻辑清晰，发布时间
+ <font color=#3eaf7c>用户选课表</font>：<font color=#DD1144>用户选课ID</font>，用户ID,课程ID，选课时间，累积听课时长

## 数据类型
### 1. 整数类型
`mysql`有5种整数类型，如图所示：

<img :src="$withBase('/mysql_two_zhengshuleixing.png')" alt="整数类型">

+ 我们知道一个字节是8位，也就是2的8次方，即256，但是还包含0，所以是0~255。其他的以此类推。
+ 所以你保存的整数如果在0~255的范围，就应该选择`tinyint`类型，很多人喜欢选择`int(2)`，这种实际限制了整数的部分，但是存储空间依旧是4个字节，数值范围也不会变，所以这种写法不对。

### 2. 实数类型
`mysql`中还有可以保存浮点数的类型，我们称为实数类型，有下面三种实数类型：

<img :src="$withBase('/mysql_two_shishuleixing.png')" alt="实数类型">

+ `float`和`double`存储的数值是非精确的，小数部分并不精准，计算后与正确的值会有偏差。
+ `decimal`类型的表示方法是这样：`decimal(10,3)`,表示一共10位，小数部分占3位。计算后与正确的值没有偏差。
+ <font color=#1E90FF>decimal类型存储小数部分是精确的，但是占用空间会更大，它的存储空间是每4个字节存9个数字，小数点占一个字节</font>，所以比如`123456789.987654321 = decimal(18,9)`,因为一共18位数字，小数点前面的9位占4个字节，小数部分的9位又占4个字节，小数点单独占一个字节。在`mysql`5.6之后最多存储65位的数字。

### 3. 时间类型
`mysql`中时间类型也是我们常用的时间类型，如下：

<img :src="$withBase('/mysql_two_shijianleixing.png')" alt="时间类型">

+ `TIME`存储空间是`3-6`个字节，因为后面还可以跟最多6位微妙值，比如`16.18.28.72`这个时间包含两位的微妙值，属于`time(2)`，它就占4个字节。`16.18.28.7182`属于`time(4)`就占5个字节。`16.18.28.718216`属于`time(6)`就占6个字节。
+ 同理`DATETIME`后面也可以跟最多6位微妙值。所以存储空间是`5~8`个字节。
+ `TIMESTAMP`是时间戳类型，包含时区信息，同一个时间在不同时区下数值会不一样。后面也可以跟最多6位微妙值。所以存储空间是`4~7`个字节。

### 4. 字符串类型
`mysql`中字符串应该是最常用的数据类型了，

<img :src="$withBase('/mysql_two_zifuchuanleixing.png')" alt="字符串类型">

+ `Char(M)`类型实际上表示`M=1~255`个字符(<font color=#DD1144>注意这里是字符</font>)，之所以说它是定长，因为无论你存储的是不是`M`个字符，都会占用`M`个字符需要的存储空间。<font color=#1E90FF>除了`Char(M)`,其他都是可变长度的字符串类型</font>。
+ `VarChar(M)`与`Char(M)`不同的是它实际占用的存储空间和实际的长度有关，<font color=#1E90FF>而且一行中所有varchar类型的列所占用的字节数不能超过65535个字节</font>。
+ 剩下的基本都是以字节为单位的存储：
	+ `TinyText`存储最大不超过255字节的字符串
	+ `Text`存储最大不超过`64k`(64*1024=65536字节)的字符串
	+ `MediumText`存储最大不超过`16M`(16*1024*1024=16777216字节)的字符串
	+ `LongText`存储最大不超过`4G`(4*1024*1024*1024=4294967296字节)的字符串

## 选择类型
### 1. 选择原则
知道了数据类型之后，我们就应该考虑如何为数据选择合适的数据类型，我们选择数据类型有很多的原则：

<font color=#DD1144>**① 优先选择符合存储数据的最小数据类型**</font>

+ 比如说`3147483647`按照有符号的我们一般都放在`Bigint`（8字节）类型中，但是如果能按照无符号的`int`（4字节）类型存储，我们就能节省4字节的存储空间
+ 再比如字符串，在`mysql`中存在可以将字符串转化成为数字来存储，比如`'255.255.255.255'`这个字符串需要15个字节的空间存储，但是利用下面这样的方式存储为无符号的int类型，只需要4个字节
	+ <font color=#1E90FF>INET_ATON('255.255.255.255') = 4294967295</font>
	+ <font color=#1E90FF>INET_NTOA(4294967295) = '255.255.255.255'</font>

<font color=#DD1144>**② 谨慎使用ENUM,TEXT字符串类型**</font>

+ 因为实际`Text`类型的字符串基本上能存`64k`的字符串，相当于能写两万多个汉字，那实际上像备注说明这些字段存储到数据库顶多用个`VarChar`类型就够够的了。<font color=#1E90FF>另外mysql的内存临时表是不支持Text类型的，所以如果Text类型的数据在排序的时候就不能使用内容临时表，而要使用磁盘临时表，速度一下就慢了很多很多</font>。
+ 所以如果一定要使用这个类型就建议分离都一个单独的扩展表中来存储，查询时不要使用`select *`，只取出必要的列，不需要的时候就不要查询。
+ `mysql`对索引的长度是有限制的，在`Text`类型上面不能进行全部的索引，而只能进行前置索引，另外`Text`列上是不能有默认值的
+ `ENUM`类型实际上是在存储字符串的时候将每个枚举值转换成为数字存储的，表面上这是我们上面优化的一种手段，但是如果要修改其中的值，必须使用`alter`语句，这在频繁修改数据库结构的核心业务场景中是不推荐的。

<font color=#DD1144>**③ 同财务相关的数值型数据，必需使用decimal类型**</font>

+ 数据库中的三个浮点数中只有`decimal`类型是计算不丢失精度的，所以财务相关的数值型数据必须要采用`decimal`类型的数据来存储。

### 2. 选择实战
在已知了所有的数据类型和数据类型选择的原则后，我们来为之前创建的那些表里面的所有的属性来选择对应的数据类型：

<font color=#1E90FF>**① 课程表**</font>

| 编号            | 分类          | 举例  |
| :-------------: |:-------------:| :-----:|
|1                | 压缩          | UglifyJS JSmin CSSO |

## 对象命名
